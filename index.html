<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Distribuidora Allana</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap');
        body { font-family: 'Roboto', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-enter { animation: slideUp 0.3s ease-out; }
        .pop-effect { animation: productPop 0.3s ease-out; }
        @keyframes productPop { 0% { transform: scale(1); } 50% { transform: scale(0.98); } 100% { transform: scale(1); } }

/* Animaci√≥n del bot√≥n del carrito */
@keyframes cartBounce {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}
.animate-cart { animation: cartBounce 0.4s ease-out; }

/* Animaci√≥n de entrada de la imagen ampliada */
@keyframes zoomIn {
    from { opacity: 0; transform: scale(0.5); }
    to { opacity: 1; transform: scale(1); }
}
.animate-zoom { animation: zoomIn 0.3s ease-out forwards; }


/* Animaci√≥n de "sacudida/salto" para el bot√≥n del producto */
@keyframes squeeze {
    0% { transform: scale(1); }
    50% { transform: scale(0.9); }
    100% { transform: scale(1); }
}
.animate-squeeze { animation: squeeze 0.3s ease-in-out; }

/* Animaci√≥n de "pop" para el flotante del carrito */
@keyframes cartPop {
    0% { transform: scale(1); }
    50% { transform: scale(1.4); }
    100% { transform: scale(1); }
}
.animate-pop { animation: cartPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }



<style>
    /* ... tus estilos existentes ... */

    @keyframes fadeInOut {
        0% { opacity: 0; transform: translateY(20px); }
        10% { opacity: 1; transform: translateY(0); }
        90% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(20px); }
    }

    @keyframes bounceHand {
        0%, 100% { transform: translateY(0) translateX(-50%) rotate(20deg); }
        50% { transform: translateY(-10px) translateX(-50%) rotate(20deg); }
    }

    .hint-animate {
        animation: fadeInOut 5s ease-in-out forwards;
    }
    .hand-animate {
        animation: bounceHand 0.8s infinite ease-in-out;
    }
</style>


    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const SUPABASE_URL = "https://ejbqlejlgprvwzrptojo.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYnFsZWpsZ3Bydnd6cnB0b2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMjkwMjIsImV4cCI6MjA3MjYwNTAyMn0.9fVItJka0MN3nlfowVudIE0AuNmfTJGQcbbqpau2Th8";
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const LOGO_URL = "https://ejbqlejlgprvwzrptojo.supabase.co/storage/v1/object/public/promo_images/logodistribuidora.png";

        function App() {
            const [cliente, setCliente] = useState(null);
            const [localidades, setLocalidades] = useState([]);
            const [productos, setProductos] = useState([]);
            const [categorias, setCategorias] = useState([]);
            const [carrito, setCarrito] = useState([]);
            const [loading, setLoading] = useState(true);
            const [busqueda, setBusqueda] = useState('');
            const [categoriaFiltro, setCategoriaFiltro] = useState(null);
            const [catOpen, setCatOpen] = useState(false);
            const [showCart, setShowCart] = useState(false);
            const [pedidoPendiente, setPedidoPendiente] = useState(null);
            const [showRecovery, setShowRecovery] = useState(false);
            const [cantidadesTemp, setCantidadesTemp] = useState({});
	    const [showHistorial, setShowHistorial] = useState(false);
            const [misPedidos, setMisPedidos] = useState([]);
const [pedidosRecuperables, setPedidosRecuperables] = useState([]);
const [showModalLogin, setShowModalLogin] = useState(false);
const [tempUser, setTempUser] = useState(null);
const [showCategoryHint, setShowCategoryHint] = useState(false);



useEffect(() => {
    const handleBeforeUnload = (e) => {
        if (carrito.length > 0) {
            e.preventDefault();
            e.returnValue = 'Tienes un pedido en curso. ¬øSeguro que quieres salir?';
        }
    };
    window.addEventListener('beforeunload', handleBeforeUnload);
    return () => window.removeEventListener('beforeunload', handleBeforeUnload);
}, [carrito]);


// Al cargar la App, recuperar el carrito guardado
useEffect(() => {
    const savedCart = localStorage.getItem('distribuidora_cart');
    if (savedCart) {
        try {
            setCarrito(JSON.parse(savedCart));
        } catch (e) {
            console.error("Error recuperando carrito");
        }
    }
}, []);

// Cada vez que el carrito cambie, guardarlo en el tel√©fono
useEffect(() => {
    localStorage.setItem('distribuidora_cart', JSON.stringify(carrito));
}, [carrito]);



useEffect(() => {
    const handlePopState = (e) => {
        // Si hay alg√∫n modal abierto, lo cerramos y evitamos que el navegador retroceda
        if (showCart || showHistorial || imgAmpliada || showModalLogin || catOpen) {
            setShowCart(false);
            setShowHistorial(false);
            setImgAmpliada(null);
            setShowModalLogin(false);
            setCatOpen(false);
            
            // Re-insertamos el estado para que el siguiente "atr√°s" s√≠ funcione o cierre otro modal
            history.pushState(null, null, window.location.pathname);
        }
    };

    // Escuchamos el evento del bot√≥n atr√°s del m√≥vil
    window.addEventListener('popstate', handlePopState);

    return () => window.removeEventListener('popstate', handlePopState);
}, [showCart, showHistorial, imgAmpliada, showModalLogin, catOpen]);

// Efecto para insertar el primer estado cuando se abre cualquier modal
useEffect(() => {
    if (showCart || showHistorial || imgAmpliada || showModalLogin || catOpen) {
        history.pushState(null, null, window.location.pathname);
    }
}, [showCart, showHistorial, imgAmpliada, showModalLogin, catOpen]);

            
useEffect(() => {
    // Muestra el hint solo si el cliente est√° logueado
    // y no ha seleccionado categor√≠a ni buscado productos.
    if (cliente && !categoriaFiltro && !busqueda && productos.length > 0) {
        setShowCategoryHint(true);
        const timer = setTimeout(() => {
            setShowCategoryHint(false);
        }, 5000); // El hint desaparece despu√©s de 5 segundos
        return () => clearTimeout(timer);
    } else {
        setShowCategoryHint(false); // Oculta el hint si ya hay filtro, b√∫squeda o no hay cliente
    }
}, [cliente, categoriaFiltro, busqueda, productos.length]); // Dependencias para que se ejecute cuando cambien


useEffect(() => {
                const session = localStorage.getItem('distribuidora_session');
                if (session) setCliente(JSON.parse(session));
                fetchData();
            }, []);

            async function fetchData() {
                const { data: locs } = await sb.from('localidades').select('*').order('nombre');
                const { data: cats } = await sb.from('categorias').select('*').order('nombre');
                const { data: prods } = await sb.from('promociones').select('*').order('nombre');
                if (locs) setLocalidades(locs);
                if (cats) setCategorias(cats);
                if (prods) {
                    setProductos(prods);
                    const initialCants = {};
                    prods.forEach(p => initialCants[p.id] = 1);
                    setCantidadesTemp(initialCants);
                }
                setLoading(false);
            }

            const filtrados = useMemo(() => {
                if (!categoriaFiltro && !busqueda) return [];
                return productos.filter(p => {
                    const cat = categorias.find(c => c.id === p.categoria_id);
                    const matchCat = categoriaFiltro === 'TODOS' || (cat && cat.nombre === categoriaFiltro);
                    const matchBus = p.nombre?.toLowerCase().includes(busqueda.toLowerCase());
                    return busqueda ? matchBus : matchCat;
                });
            }, [productos, categorias, categoriaFiltro, busqueda]);

            const updateTempCant = (id, delta, stock) => {
                setCantidadesTemp(prev => ({
                    ...prev,
                    [id]: Math.max(1, Math.min(stock, (prev[id] || 1) + delta))
                }));
            };

           const agregarAlCarrito = (prod) => {
    const qtyAAgregar = cantidadesTemp[prod.id] || 1;
    const itemEnCarrito = carrito.find(i => i.id === prod.id);
    const cantidadTotalPostCheck = (itemEnCarrito ? itemEnCarrito.cantidad : 0) + qtyAAgregar;

    if (prod.stock < cantidadTotalPostCheck) {
        alert(`No hay stock suficiente. M√°ximo disponible: ${prod.stock}`);
        return;
    }

    setCarrito(prev => {
        if (itemEnCarrito) {
            return prev.map(i => i.id === prod.id 
                ? { ...i, cantidad: i.cantidad + qtyAAgregar } 
                : i
            );
        }
        return [...prev, { ...prod, cantidad: qtyAAgregar }];
    });
    
    // ACTIVAR ANIMACI√ìN
    setCartAnimating(true);
    setTimeout(() => setCartAnimating(false), 400); // Se apaga despu√©s de 400ms
    
    setCantidadesTemp(prev => ({ ...prev, [prod.id]: 1 }));
};


const cargarHistorial = async () => {
    const { data, error } = await sb
        .from('pedidos')
        .select('*')
        .eq('dni', cliente.dni)
        .order('created_at', { ascending: false });
    
    if (data) setMisPedidos(data);
    setShowHistorial(true);
};


const [imgAmpliada, setImgAmpliada] = useState(null);
const [cartAnimating, setCartAnimating] = useState(false);

// Funci√≥n para ampliar imagen con auto-cierre
const ampliarImagen = (url) => {
    setImgAmpliada(url);
    setTimeout(() => setImgAmpliada(null), 3000);
};

 
            const generarPDF = (items, total) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Fondo encabezado
                doc.setFillColor(23, 37, 84); // Azul oscuro
                doc.rect(0, 0, 210, 40, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(22);
                doc.setFont("helvetica", "bold");
                doc.text("DISTRIBUIDORA ALLANA", 105, 20, { align: "center" });
                doc.setFontSize(10);
                doc.text("COMPROBANTE DE PEDIDO", 105, 30, { align: "center" });

                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                doc.text(`Cliente: ${cliente.nombre}`, 15, 55);
                doc.text(`DNI: ${cliente.dni}`, 15, 62);
                doc.text(`Localidad: ${cliente.localidad_nombre}`, 15, 69);
                doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 150, 55);

                const body = items.map(i => [i.nombre.toUpperCase(), i.cantidad, `$${i.precio.toFixed(2)}`, `$${(i.precio * i.cantidad).toFixed(2)}`]);

                doc.autoTable({
                    startY: 80,
                    head: [['Producto', 'Cant.', 'Precio Unit.', 'Subtotal']],
                    body: body,
                    headStyles: { fillColor: [23, 37, 84] },
                    theme: 'grid'
                });

                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text(`TOTAL A PAGAR: $${total.toFixed(2)}`, 195, finalY, { align: "right" });

                doc.save(`Pedido_Allana_${cliente.nombre.replace(/\s/g, '_')}.pdf`);
            };

           



const modificarCantidadCarrito = (id, delta) => {
    setCarrito(prev => prev.map(item => {
        if (item.id === id) {
            const nuevaCant = item.cantidad + delta;
            // Si la cantidad llega a 0, podr√≠as eliminarlo o dejarlo en 1. 
            // Aqu√≠ lo limitamos a 1, el bot√≥n eliminar se encarga del resto.
            if (nuevaCant < 1) return item; 
            if (nuevaCant > item.stock) {
                alert("L√≠mite de stock alcanzado");
                return item;
            }
            return { ...item, cantidad: nuevaCant };
        }
        return item;
    }));
};

const eliminarDelCarrito = (id) => {
    setCarrito(prev => prev.filter(item => item.id !== id));
};



const recuperarPedido = (pedido) => {
    // Transformamos el JSON de la DB al formato del carrito
    const productosRecuperados = pedido.productos.map(p => ({
        ...p,
        // Buscamos el stock actual del producto para no cargar algo agotado
        stock: productos.find(prod => prod.id === p.id)?.stock || 0
    }));
    
    setCarrito(productosRecuperados);
    setCliente(tempUser);
    localStorage.setItem('distribuidora_session', JSON.stringify(tempUser));
    setShowModalLogin(false);
};



const confirmarPedido = async () => {
    if (carrito.length === 0) return;
    
    // 1. Calculamos el total
    const total = carrito.reduce((acc, i) => acc + (i.precio * i.cantidad), 0);
    
    // 2. Limpiamos el objeto del carrito para la base de datos (evita errores de JSON)
    const productosParaDB = carrito.map(item => ({
        id: item.id,
        nombre: item.nombre,
        cantidad: item.cantidad,
        precio: item.precio,
        subtotal: item.precio * item.cantidad
    }));

    try {
        // 3. Insertar el pedido en Supabase
        const { error: pError } = await sb.from('pedidos').insert([{
            cliente: cliente.nombre, 
            dni: cliente.dni, 
            localidad_id: parseInt(cliente.localidad_id), // Aseguramos que sea n√∫mero
            productos: productosParaDB, 
            total: total,
            created_at: new Date().toISOString()
        }]);

        if (pError) throw pError;

        // 4. Descontar Stock mediante RPC
        const stockPromises = carrito.map(item => 
            sb.rpc('decrement_stock', { row_id: item.id, amount: item.cantidad })
        );
        
        await Promise.all(stockPromises);

        // 5. √âxito: Feedback, PDF y Limpieza
        alert("üöÄ ¬°Pedido enviado con √©xito y stock actualizado!");
        generarPDF(carrito, total);
        
        setCarrito([]);
        setShowCart(false);
        fetchData(); // Recargamos productos para ver el nuevo stock en la lista

    } catch (error) {
        console.error("Error completo:", error);
        alert(`Error al procesar: ${error.message || 'Verifica tu conexi√≥n'}`);
    }
};

            if (loading) return <div className="h-screen flex items-center justify-center font-black text-blue-900 animate-pulse">CARGANDO...</div>;

            if (!cliente) return (
    <div className="min-h-screen bg-blue-900 flex items-center justify-center p-6 relative">
        {/* MODAL DE RECUPERACI√ìN (Aparece solo si hay pedidos previos) */}
        {showModalLogin && (
            <div className="fixed inset-0 z-[100] flex items-center justify-center bg-blue-900/90 backdrop-blur-xl p-4">
                <div className="bg-white w-full max-w-sm rounded-[2.5rem] p-8 modal-enter shadow-2xl">
                    <div className="text-center mb-6">
                        <div className="text-4xl mb-2">üëã</div>
                        <h2 className="text-2xl font-black text-blue-900 uppercase leading-tight">¬°Hola de nuevo!</h2>
                        <p className="text-gray-400 text-sm font-bold mt-1">¬øQu√© deseas hacer hoy?</p>
                    </div>
                    <div className="space-y-3 mb-6">
                        {pedidosRecuperables.slice(0, 1).map(p => (
                            <button key={p.id} onClick={() => {
                                setCarrito(p.productos);
                                setCliente(tempUser);
                                localStorage.setItem('distribuidora_session', JSON.stringify(tempUser));
                                setShowModalLogin(false);
                            }} className="w-full bg-blue-50 border-2 border-blue-900 p-4 rounded-2xl text-left">
                                <p className="text-[10px] font-black text-blue-900/50 uppercase">√öltimo pedido: {new Date(p.created_at).toLocaleDateString()}</p>
                                <span className="font-black text-blue-900 text-sm italic">RECUPERAR Y EDITAR ESTE PEDIDO</span>
                            </button>
                        ))}
                        <button onClick={() => {
                            setCliente(tempUser);
                            localStorage.setItem('distribuidora_session', JSON.stringify(tempUser));
                            setCarrito([]);
                            setShowModalLogin(false);
                        }} className="w-full bg-blue-900 text-white py-5 rounded-2xl font-black uppercase shadow-lg">
                            Empezar Pedido Nuevo
                        </button>
                    </div>
                </div>
            </div>
        )}

        <form onSubmit={async (e) => {
            e.preventDefault();
            const form = e.target;
            const datos = {
                nombre: form.nombre.value,
                dni: form.dni.value,
                localidad_id: form.localidad.value,
                localidad_nombre: form.localidad.options[form.localidad.selectedIndex].text
            };

            try {
                const { data, error } = await sb.from('pedidos').select('*').eq('dni', datos.dni).order('created_at', { ascending: false });
                if (!error && data && data.length > 0) {
                    setPedidosRecuperables(data);
                    setTempUser(datos);
                    setShowModalLogin(true);
                } else {
                    setCliente(datos);
                    localStorage.setItem('distribuidora_session', JSON.stringify(datos));
                }
            } catch (err) {
                setCliente(datos); // Si hay error de red, entra igual
                localStorage.setItem('distribuidora_session', JSON.stringify(datos));
            }
        }} className="bg-white p-8 rounded-[2.5rem] w-full max-w-sm flex flex-col items-center shadow-2xl">
            <img src={LOGO_URL} className="w-40 mb-6" />
            <input name="nombre" placeholder="Nombre Completo" className="w-full bg-gray-50 border-2 p-4 mb-3 rounded-2xl outline-none focus:border-blue-900" required />
            <input name="dni" type="number" placeholder="DNI" className="w-full bg-gray-50 border-2 p-4 mb-3 rounded-2xl outline-none focus:border-blue-900" required />
            <select name="localidad" className="w-full bg-gray-50 border-2 p-4 mb-6 rounded-2xl outline-none focus:border-blue-900" required>
                <option value="">Tu Localidad</option>
                {localidades.map(l => <option key={l.id} value={l.id}>{l.nombre}</option>)}
            </select>
            <button type="submit" className="w-full bg-blue-900 text-white py-5 rounded-2xl font-black uppercase tracking-widest active:scale-95 transition-transform">
                Ingresar
            </button>
        </form>
    </div>
);

            return (
                <div className="min-h-screen flex flex-col pb-24">
                    <header className="bg-white p-3 shadow-sm sticky top-0 z-40">
    <div className="max-w-2xl mx-auto flex items-center justify-between">
        {/* Lado Izquierdo: Logo y Datos debajo */}
        <div className="flex flex-col">
            <img src={LOGO_URL} className="h-12 object-contain self-start mb-1" />
            <div className="leading-tight">
                <p className="text-[16px] font-black text-blue-900 uppercase tracking-tighter">
                    {cliente.nombre}
                </p>
                <p className="text-[14px] font-bold text-gray-400 uppercase">
                    {cliente.localidad_nombre}
                </p>
            </div>
        </div>

        

    <button 
        onClick={async () => {
            const { data } = await sb.from('pedidos').select('*').eq('dni', cliente.dni).order('created_at', { ascending: false });
            setMisPedidos(data || []);
            setShowHistorial(true);
        }}
        className="text-[14px] font-black text-blue-900 bg-blue-50 px-4 py-2 rounded-xl uppercase border border-blue-100 active:bg-blue-100"
    >
        üìã Historial de Pedidos
    </button>
    <button 
        onClick={() => {localStorage.clear(); location.reload();}} 
        className="text-[14px] font-black text-red-500 bg-red-50 px-4 py-2 rounded-xl uppercase border border-red-100 active:bg-red-100"
    >
        Salir
    </button>
</div>


    {/* Buscador: Debajo de todo con margen reducido */}
    <div className="max-w-2xl mx-auto mt-3">
        <input 
            type="text" 
            placeholder="üîé Buscar productos..." 
            className="w-full bg-gray-100 p-3 rounded-xl outline-none text-xs border-2 border-transparent focus:border-blue-900 transition-all" 
            onChange={(e) => setBusqueda(e.target.value)} 
        />
    </div>



</header>



                    <main className="p-4 flex-grow max-w-2xl mx-auto w-full">
    {/* Contenedor relativo para posicionar la gu√≠a sobre el bot√≥n */}
    <div className="relative mb-6">
        
        {/* Animaci√≥n de Bienvenida y Gu√≠a sobre el bot√≥n */}
        {showCategoryHint && (
            <div className="absolute -top-16 left-1/2 -translate-x-1/2 z-50 text-center w-full hint-animate pointer-events-none">
                <div className="flex flex-col items-center">
                    <p className="bg-blue-900 text-white px-6 py-3 rounded-full text-[11px] font-black uppercase tracking-widest shadow-2xl border-2 border-white mb-1">
                        ¬°Selecciona una categor√≠a para comenzar!
                    </p>
                    <span className="text-4xl hand-animate inline-block">üëá</span>
                </div>
            </div>
        )}

        {/* Selector de Categor√≠as */}
        <button 
            onClick={() => {
                setCatOpen(!catOpen);
                setShowCategoryHint(false); // Se oculta al interactuar
            }} 
            className="w-full bg-white p-5 rounded-2xl border-2 border-white shadow-sm flex justify-between items-center font-black text-blue-900 uppercase text-[14px] active:scale-[0.98] transition-transform"
        >
            <span>üì¶ CATEGOR√çA: {categoriaFiltro || 'SELECCIONAR'}</span>
            <span className={`transition-transform duration-300 ${catOpen ? 'rotate-180' : ''}`}>‚ñº</span>
        </button>

        {catOpen && (
            <div className="absolute w-full mt-2 bg-white rounded-2xl shadow-xl border overflow-hidden modal-enter z-40">
                <button 
                    onClick={() => { setCategoriaFiltro('TODOS'); setCatOpen(false); }} 
                    className="w-full p-4 text-left border-b hover:bg-gray-50 font-bold text-xs text-gray-400 uppercase"
                >
                    Mostrar Todo
                </button>
                {categorias.map(c => (
                    <button 
                        key={c.id} 
                        onClick={() => { setCategoriaFiltro(c.nombre); setCatOpen(false); }} 
                        className="w-full p-4 text-left border-b font-black text-xs text-blue-900 uppercase active:bg-blue-50"
                    >
                        {c.nombre}
                    </button>
                ))}
            </div>
        )}
    </div>

    {/* Listado de Productos */}
    <div className="grid grid-cols-1 gap-4">
        {filtrados.length === 0 && !loading && (
            <div className="text-center py-20 bg-gray-50/50 rounded-[3rem] border-2 border-dashed border-gray-200">
                <p className="text-gray-400 font-black uppercase tracking-widest text-sm px-10">
                    {busqueda || categoriaFiltro ? "No hay productos disponibles" : "Selecciona una categor√≠a para ver los productos"}
                </p>
            </div>
        )}

        {filtrados.map(p => {
            const precioAnt = (p.precio * 1.30).toLocaleString('es-AR', { style: 'currency', currency: 'ARS' });
            const precioActual = p.precio.toLocaleString('es-AR', { style: 'currency', currency: 'ARS' });
            const stockColor = p.stock > 10 ? 'text-green-600 bg-green-50' : p.stock > 0 ? 'text-orange-600 bg-orange-50' : 'text-red-600 bg-red-50';
            const stockLabel = p.stock > 0 ? `${p.stock} unidades` : 'Sin stock';

            return (
                <div key={p.id} className="bg-white p-4 rounded-[2rem] shadow-sm border border-gray-100 flex gap-4 items-center relative overflow-hidden transition-all active:scale-[0.98]">
                    {/* Badge de Oferta */}
                    <div className="absolute top-0 left-0 bg-red-500 text-white text-[8px] font-black px-3 py-1 rounded-br-xl uppercase">
                        
                    </div>

                    {/* Imagen con evento de click */}
                    <div 
                        onClick={() => ampliarImagen(`${SUPABASE_URL}/storage/v1/object/public/promo_images/${p.imagen}`)}
                        className="w-24 h-24 flex-shrink-0 bg-gray-50 rounded-2xl p-2 flex items-center justify-center cursor-zoom-in active:opacity-70 transition-opacity"
                    >
                        <img 
                            src={`${SUPABASE_URL}/storage/v1/object/public/promo_images/${p.imagen}`} 
                            className="max-w-full max-h-full object-contain"
                        />
                    </div>

                    {/* Informaci√≥n */}
                    <div className="flex-1 flex flex-col justify-between h-28">
                        <div>
                            <h3 className="text-[11px] font-bold uppercase text-gray-500 leading-tight mb-1">{p.nombre}</h3>
                            
                            {/* Visualizador de Stock */}
                            <div className={`inline-flex items-center gap-1.5 px-2 py-0.5 rounded-md ${stockColor} mb-2`}>
                                <div className={`w-1.5 h-1.5 rounded-full ${stockColor.replace('text', 'bg').split(' ')[0]}`}></div>
                                <span className="text-[12px] font-black uppercase tracking-tighter">{stockLabel}</span>
                            </div>

                            <div className="flex items-baseline gap-2">
                                <span className="text-blue-900 font-black text-xl">{precioActual}</span>
                                <span className="text-gray-400 text-xs line-through">{precioAnt}</span>
                            </div>
                        </div>

                        {/* Controles */}
                        <div className="flex items-center gap-2">
                            <div className="flex items-center bg-gray-100 rounded-lg p-0.5 border">
                                <button onClick={() => updateTempCant(p.id, -1, p.stock)} className="w-7 h-7 font-black text-blue-900">-</button>
                                <span className="w-6 text-center text-xs font-black">{cantidadesTemp[p.id] || 1}</span>
                                <button onClick={() => updateTempCant(p.id, 1, p.stock)} className="w-7 h-7 font-black text-blue-900">+</button>
                            </div>
                            <button 
                                onClick={() => agregarAlCarrito(p)} 
                                disabled={p.stock <= 0}
                                className="flex-1 bg-blue-900 text-white py-2 rounded-lg font-black text-[9px] uppercase tracking-tighter disabled:bg-gray-300 transition-all active:bg-blue-800"
                            >
                                {p.stock > 0 ? 'Agregar' : 'Agotado'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        })}
    </div>
</main>

                    <div className="fixed bottom-6 right-6 z-50">
    <button 
        onClick={() => setShowCart(true)} 
        className={`w-16 h-16 rounded-full bg-blue-900 shadow-2xl flex items-center justify-center border-4 border-white transition-all ${cartAnimating ? 'animate-pop' : ''}`}
    >
        <span className="text-2xl">üõí</span>
        {carrito.length > 0 && (
            <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-black w-7 h-7 rounded-full flex items-center justify-center border-2 border-white">
                {carrito.reduce((acc, i) => acc + i.cantidad, 0)}
            </span>
        )}
    </button>
</div>

                    {showCart && (
    <div className="fixed inset-0 bg-black/60 z-[60] flex items-end backdrop-blur-sm" onClick={() => setShowCart(false)}>
        <div className="bg-white w-full max-h-[90vh] rounded-t-[2.5rem] p-8 flex flex-col modal-enter shadow-2xl" onClick={e => e.stopPropagation()}>
            
            {/* Bot√≥n Seguir Agregando */}
            <button 
                onClick={() => setShowCart(false)}
                className="mb-4 self-center bg-gray-100 text-gray-500 px-6 py-2 rounded-full font-black text-[15px] uppercase tracking-widest border border-gray-200 active:scale-95 transition-all"
            >
                ‚Üë Seguir agregando productos
            </button>

            <h2 className="text-2xl font-black text-blue-900 mb-6 uppercase flex justify-between items-center">
                Tu Pedido
                <span className="text-xs bg-blue-100 text-blue-900 px-3 py-1 rounded-full">{carrito.length} Items</span>
            </h2>

            <div className="flex-grow overflow-y-auto space-y-4 mb-6 no-scrollbar">
                {carrito.length === 0 ? (
                    <p className="text-center py-10 text-gray-400 font-bold">Tu carrito est√° vac√≠o</p>
                ) : (
                    carrito.map(item => (
                        <div key={item.id} className="flex justify-between items-center bg-gray-50 p-4 rounded-2xl border border-gray-100">
                            <div className="flex-1">
                                <p className="text-[15px] font-black uppercase text-gray-700 leading-tight mb-1">{item.nombre}</p>
                                <div className="flex items-center gap-3">
                                    <div className="flex items-center bg-white rounded-lg border shadow-sm">
                                        <button onClick={() => modificarCantidadCarrito(item.id, -1)} className="w-8 h-8 text-blue-900 font-black">-</button>
                                        <span className="w-8 text-center text-xs font-black">{item.cantidad}</span>
                                        <button onClick={() => modificarCantidadCarrito(item.id, 1)} className="w-8 h-8 text-blue-900 font-black">+</button>
                                    </div>
                                    <button onClick={() => eliminarDelCarrito(item.id)} className="text-red-400 text-[15px] font-bold uppercase underline">Eliminar Producto</button>
                                </div>
                            </div>
                            <div className="text-right">
                                <p className="font-black text-blue-900">${(item.precio * item.cantidad).toLocaleString('es-AR')}</p>
                                <p className="text-[9px] text-gray-400 font-bold">${item.precio.toLocaleString('es-AR')} c/u</p>
                            </div>
                        </div>
                    ))
                )}
            </div>

            <div className="border-t pt-6">
                <div className="flex justify-between items-end mb-6">
                    <div>
                        <span className="text-gray-400 font-black uppercase text-[10px] block">Total estimado</span>
                        <span className="text-3xl font-black text-blue-900">${carrito.reduce((acc, i) => acc + (i.precio * i.cantidad), 0).toLocaleString('es-AR')}</span>
                    </div>
                </div>
                
                <button 
                    onClick={confirmarPedido} 
                    disabled={carrito.length === 0}
                    className="w-full bg-green-600 text-white py-6 rounded-2xl font-black uppercase shadow-xl active:scale-[0.98] transition-transform disabled:bg-gray-300"
                >
                    Confirmar y Descargar PDF
                </button>
            </div>
        </div>
    </div>
)}
{imgAmpliada && (
    <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-md p-6" onClick={() => setImgAmpliada(null)}>
        <div className="relative animate-zoom">
            <img 
                src={imgAmpliada} 
                className="max-w-full max-h-[70vh] rounded-3xl shadow-2xl border-4 border-white" 
            />
            <div className="absolute -bottom-12 left-0 right-0 text-center text-white font-black uppercase text-xs tracking-widest">
                Se cerrar√° autom√°ticamente...
            </div>
        </div>
    </div>
)}


{showHistorial && (
    <div className="fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div className="bg-white w-full max-w-md max-h-[80vh] rounded-[2rem] p-6 flex flex-col shadow-2xl">
            <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-black text-blue-900 uppercase">Mis Pedidos</h2>
                <button onClick={() => setShowHistorial(false)} className="text-gray-400 font-bold">CERRAR</button>
            </div>
            
            <div className="overflow-y-auto space-y-3 no-scrollbar">
                {misPedidos.length === 0 ? (
                    <p className="text-center py-10 text-gray-400">No tienes pedidos anteriores.</p>
                ) : (
                    misPedidos.map(p => (
                        <div key={p.id} className="bg-gray-50 p-4 rounded-2xl border flex justify-between items-center">
                            <div>
                                <p className="text-[10px] font-bold text-gray-400">{new Date(p.created_at).toLocaleDateString()}</p>
                                <p className="font-black text-blue-900">${p.total.toLocaleString('es-AR')}</p>
                                <p className="text-[10px] uppercase font-bold text-gray-500">{p.productos.length} productos</p>
                            </div>
                            <button 
                                onClick={() => generarPDF(p.productos, p.total)}
                                className="bg-white border-2 border-blue-900 text-blue-900 p-2 rounded-xl text-[10px] font-black uppercase"
                            >
                                Re-descargar PDF
                            </button>
                        </div>
                    ))
                )}
            </div>
        </div>
    </div>
)}



                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
